<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/login"></ion-back-button>
    </ion-buttons>
    <ion-title>Recuperar Contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Skeleton Loading State -->
  @if (showSkeleton()) {
    <ion-skeleton-text animated style="width: 100%; height: 200px; border-radius: 16px;"></ion-skeleton-text>
  } @else {
    <!-- Forgot Password Form -->
    <div class="form-container">
      <ion-card #forgotCard class="forgot-card">
        <ion-card-header>
          <ion-card-title class="form-title">
            <ion-icon name="mail" color="primary"></ion-icon>
            ¿Olvidaste tu contraseña?
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <!-- Success State -->
          @if (emailSent()) {
            <div class="success-message">
              <ion-icon name="checkmark-circle" color="success" class="success-icon"></ion-icon>
              <h2>¡Correo enviado!</h2>
              <p>Hemos enviado un enlace de recuperación a tu correo electrónico.</p>

              <ion-button
                expand="block"
                fill="outline"
                (click)="resendEmail()"
                [disabled]="isLoading()">
                Reenviar correo
              </ion-button>

              <ion-button
                expand="block"
                fill="clear"
                (click)="navigateToLogin()">
                Volver al inicio de sesión
              </ion-button>
            </div>
          } @else {
            <!-- Request Form State -->
            <p class="instruction-text">
              Ingresa tu email y te enviaremos un enlace para restablecer tu contraseña.
            </p>

            <form #forgotFormRef="ngForm" [formGroup]="forgotFormGroup" (ngSubmit)="onSubmit()">
              <!-- Email Input -->
              <ion-item
                class="form-item"
                [class.item-has-error]="emailErrors">
                <ion-icon name="mail" slot="start" color="medium"></ion-icon>
                <ion-input
                  label="Email"
                  labelPlacement="floating"
                  formControlName="email"
                  type="email"
                  placeholder="tu@email.com"
                  autocomplete="email">
                </ion-input>
              </ion-item>

              <!-- Submit Button -->
              <ion-button
                expand="block"
                type="submit"
                [disabled]="!isFormValid || isLoading()"
                [class.loading]="isLoading()">

                @if (!isLoading()) {
                  <span>
                    Enviar enlace
                  </span>
                } @else {
                  <span class="loading-content">
                    <ion-spinner name="circular" color="light"></ion-spinner>
                    Enviando...
                  </span>
                }
              </ion-button>

              <!-- Back to Login -->
              <ion-button
                fill="clear"
                expand="full"
                (click)="navigateToLogin()">
                Volver al inicio de sesión
              </ion-button>
            </form>
          }
        </ion-card-content>
      </ion-card>

      <!-- Loading Progress -->
      @if (authLoading().isLoading && authLoading().progress) {
        <div class="loading-progress">
          <ion-progress-bar
            [value]="authLoading().progress! / 100"
            color="primary">
          </ion-progress-bar>
          <p class="progress-text">{{ authLoading().message }}</p>
        </div>
      }
    </div>
  }
</ion-content>
