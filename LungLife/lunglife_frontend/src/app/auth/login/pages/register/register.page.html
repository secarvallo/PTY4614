<ion-content data-test="register-page">
  <div class="content-wrapper">
    <div class="centered-container">
      <div class="auth-header">
        <div class="logo-placeholder"></div>
        <h1>Crear Cuenta</h1>
        <p>Únete a LungLife y protege tu salud respiratoria</p>
      </div>

      <form [formGroup]="registerForm" (ngSubmit)="onRegister()" class="auth-form" data-test="register-form">

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="nombre"
              placeholder="Nombre *"
              data-test="register-nombre"
            ></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="registerForm.get('nombre')?.invalid && registerForm.get('nombre')?.touched">
            <span *ngIf="registerForm.get('nombre')?.hasError('required')">El nombre es requerido</span>
            <span
              *ngIf="registerForm.get('nombre')?.hasError('minlength')">El nombre debe tener al menos 2 caracteres</span>
            <span *ngIf="registerForm.get('nombre')?.hasError('maxlength')">El nombre no puede tener más de 50 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="apellido"
              placeholder="Apellido"
              data-test="register-apellido"
            ></ion-input>
          </ion-item>
          <div class="error-message"
               *ngIf="registerForm.get('apellido')?.invalid && registerForm.get('apellido')?.touched">
            <span *ngIf="registerForm.get('apellido')?.hasError('maxlength')">El apellido no puede tener más de 50 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="email"
              type="email"
              placeholder="Correo electrónico *"
              data-test="register-email"
            ></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
            <span *ngIf="registerForm.get('email')?.hasError('required')">El email es requerido</span>
            <span *ngIf="registerForm.get('email')?.hasError('email')">Formato de email inválido</span>
          </div>
        </div>

        <div class="form-group phone-field-container">
          <ion-label position="stacked" class="input-label">
            Teléfono *
          </ion-label>
          <div class="phone-input-wrapper">
            <ngx-intl-tel-input
              [preferredCountries]="[CountryISO.Chile, CountryISO.Colombia, CountryISO.UnitedStates]"
              [enableAutoCountrySelect]="true"
              [enablePlaceholder]="true"
              [searchCountryFlag]="true"
              [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
              [selectFirstCountry]="false"
              [selectedCountryISO]="CountryISO.Chile"
              [maxLength]="15"
              [phoneValidation]="true"
              [separateDialCode]="true"
              [numberFormat]="PhoneNumberFormat.National"
              formControlName="telefono"
              data-test="register-telefono">
            </ngx-intl-tel-input>
          </div>
          <div class="error-message"
               *ngIf="registerForm.get('telefono')?.invalid && registerForm.get('telefono')?.touched">
            <ion-icon name="alert-circle-outline"></ion-icon>
            {{ registerForm.get('telefono')?.hasError('required') ? 'El teléfono es requerido' : 'Número de teléfono inválido' }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="fechaNacimiento"
              type="date"
              placeholder="Fecha de Nacimiento"
              data-test="register-fechaNacimiento"
            ></ion-input>
          </ion-item>
        </div>

        <div class="form-group password-field-container">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="password"
              [type]="showPassword() ? 'text' : 'password'"
              placeholder="Contraseña *"
              data-test="register-password"
            ></ion-input>
            <ion-button fill="clear" slot="end" (click)="togglePassword()">
              <ion-icon [name]="showPassword() ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <ion-icon
            *ngIf="passwordSecurityStatus().show"
            name="shield-checkmark-outline"
            class="security-shield-indicator"
            [color]="passwordSecurityStatus().color"
            [class]="passwordSecurityStatus().cssClass"
          ></ion-icon>
          <div class="password-requirements" *ngIf="registerForm.get('password')?.touched">
            <div class="requirement" [class.met]="passwordChecks.minLength">
              <ion-icon [name]="passwordChecks.minLength ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              Mínimo 8 caracteres
            </div>
            <div class="requirement" [class.met]="passwordChecks.uppercase">
              <ion-icon [name]="passwordChecks.uppercase ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              Una mayúscula
            </div>
            <div class="requirement" [class.met]="passwordChecks.lowercase">
              <ion-icon [name]="passwordChecks.lowercase ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              Una minúscula
            </div>
            <div class="requirement" [class.met]="passwordChecks.number">
              <ion-icon [name]="passwordChecks.number ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              Un número
            </div>
            <div class="requirement" [class.met]="passwordChecks.special">
              <ion-icon [name]="passwordChecks.special ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              Un carácter especial
            </div>
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-input
              formControlName="confirmPassword"
              [type]="showConfirmPassword() ? 'text' : 'password'"
              placeholder="Confirmar Contraseña *"
              data-test="register-confirm-password"
            ></ion-input>
            <ion-button fill="clear" slot="end" (click)="toggleConfirmPassword()">
              <ion-icon [name]="showConfirmPassword() ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="error-message"
               *ngIf="registerForm.get('confirmPassword')?.touched && registerForm.hasError('passwordMismatch')">
            <span>Las contraseñas no coinciden</span>
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <ion-checkbox formControlName="acceptTerms" shape="round" color="primary"></ion-checkbox>
            <span class="checkbox-label">Acepto los <ion-button fill="clear" size="small" routerLink="/terms" class="policy-link">Términos y Condiciones</ion-button></span>
          </div>
          <div class="checkbox-item">
            <ion-checkbox formControlName="acceptPrivacy" shape="round" color="primary"></ion-checkbox>
            <span class="checkbox-label">Acepto la <ion-button fill="clear" size="small" routerLink="/privacy" class="policy-link">Política de Privacidad</ion-button></span>
          </div>
          <div class="checkbox-item">
            <ion-checkbox formControlName="acceptMarketing" shape="round" color="primary"></ion-checkbox>
            <span class="checkbox-label">Deseo recibir comunicaciones de marketing (opcional)</span>
          </div>
        </div>

        <ion-button
          expand="block"
          type="submit"
          [disabled]="registerForm.invalid || loading()"
          class="main-action-button"
          color="primary"
          shape="round"
          size="large"
          data-test="register-submit"
        >
          <ion-spinner *ngIf="loading()" name="crescent"></ion-spinner>
          <span *ngIf="!loading()">Crear Cuenta</span>
        </ion-button>
      </form>

      <div class="auth-footer">
        <p>¿Ya tienes cuenta?</p>
        <ion-button fill="clear" type="button" routerLink="/auth/login" class="link-button">
          <strong>Inicia sesión aquí</strong>
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>
