<ion-content class="ion-padding" data-test="profile-form-page">
  <!-- Loading State -->
  <div *ngIf="isProfileLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="profileLoadError && !isProfileLoading" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
    <p>{{ profileLoadError }}</p>
    <ion-button fill="outline" (click)="loadUserProfile()">Reintentar</ion-button>
  </div>

  <!-- Welcome Content - Only show when loaded -->
  <div class="welcome-container" *ngIf="!isProfileLoading">

    <!-- ========== PERFIL DE ADMINISTRADOR ========== -->
    <div *ngIf="isAdmin && adminProfile" class="admin-profile-section">
      <div class="action-section">
        <div class="auth-header">
          <div class="logo-placeholder admin-badge">
            <ion-icon name="shield-checkmark"></ion-icon>
          </div>
          <div class="header-content">
            <div class="header-text">
              <h1>Panel de Administrador</h1>
              <p>{{ userEmail }}</p>
            </div>
          </div>
        </div>

        <div class="admin-stats-grid">
          <div class="stat-card">
            <ion-icon name="people-outline" color="primary"></ion-icon>
            <div class="stat-content">
              <h3>{{ adminProfile.systemStats.totalUsers }}</h3>
              <p>Usuarios Totales</p>
            </div>
          </div>
          <div class="stat-card">
            <ion-icon name="person-outline" color="success"></ion-icon>
            <div class="stat-content">
              <h3>{{ adminProfile.systemStats.totalPatients }}</h3>
              <p>Pacientes</p>
            </div>
          </div>
          <div class="stat-card">
            <ion-icon name="medkit-outline" color="tertiary"></ion-icon>
            <div class="stat-content">
              <h3>{{ adminProfile.systemStats.totalDoctors }}</h3>
              <p>Médicos</p>
            </div>
          </div>
          <div class="stat-card">
            <ion-icon name="link-outline" color="warning"></ion-icon>
            <div class="stat-content">
              <h3>{{ adminProfile.systemStats.activeAssignments }}</h3>
              <p>Asignaciones Activas</p>
            </div>
          </div>
        </div>

        <div class="admin-actions">
          <ion-button expand="block" routerLink="/admin/users">
            <ion-icon slot="start" name="people"></ion-icon>
            Gestionar Usuarios
          </ion-button>
          <ion-button expand="block" fill="outline" routerLink="/dashboard">
            <ion-icon slot="start" name="home"></ion-icon>
            Ir al Dashboard
          </ion-button>
        </div>
      </div>
    </div>

    <!-- ========== PERFIL DE MÉDICO ========== -->
    <div *ngIf="isDoctor && doctorProfile" class="doctor-profile-section">
      <div class="action-section profile-section">
        <!-- Header con Badge y Título -->
        <div class="auth-header">
          <div class="header-content">
            <div class="doctor-avatar">
              <ion-icon name="medkit"></ion-icon>
            </div>
            <div class="header-text">
              <h1>Dr. {{ doctorProfile.fullName }}</h1>
              <p class="specialty-badge">
                <ion-icon name="ribbon-outline"></ion-icon>
                {{ doctorProfile.specialty || 'Especialidad no especificada' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Estadística Destacada -->
        <div class="doctor-highlight-card">
          <div class="highlight-content">
            <div class="highlight-icon">
              <ion-icon name="people"></ion-icon>
            </div>
            <div class="highlight-info">
              <span class="highlight-number">{{ doctorProfile.patientCount || 0 }}</span>
              <span class="highlight-label">Pacientes Asignados</span>
            </div>
          </div>
        </div>

        <!-- Sección: Información Profesional -->
        <div class="form-section">
          <div class="form-section-header">
            <h3><ion-icon name="briefcase-outline"></ion-icon> Información Profesional</h3>
            <p>Datos de tu perfil médico</p>
          </div>

          <div class="view-field">
            <label>Licencia Médica</label>
            <p>{{ doctorProfile.medicalLicense || 'No especificada' }}</p>
          </div>

          <div class="view-field">
            <label>Especialidad</label>
            <p>{{ doctorProfile.specialty || 'No especificada' }}</p>
          </div>

          <div class="view-field">
            <label>Institución / Hospital</label>
            <p>{{ doctorProfile.hospitalInstitution || 'No especificada' }}</p>
          </div>
        </div>

        <!-- Sección: Información Personal -->
        <div class="form-section">
          <div class="form-section-header">
            <h3><ion-icon name="person-outline"></ion-icon> Información Personal</h3>
            <p>Datos personales del médico</p>
          </div>

          <div class="view-field">
            <label>Nombre Completo</label>
            <p>{{ doctorProfile.fullName }}</p>
          </div>

          <div class="view-fields-row">
            <div class="view-field">
              <label>Fecha de Nacimiento</label>
              <p>{{ doctorProfile.dateOfBirth ? (doctorProfile.dateOfBirth | date:'dd/MM/yyyy') : 'No especificada' }}</p>
            </div>
            <div class="view-field">
              <label>Género</label>
              <p>{{ doctorProfile.gender || 'No especificado' }}</p>
            </div>
          </div>
        </div>

        <!-- Sección: Información de Contacto -->
        <div class="form-section">
          <div class="form-section-header">
            <h3><ion-icon name="call-outline"></ion-icon> Información de Contacto</h3>
            <p>Datos de contacto profesional</p>
          </div>

          <div class="view-field">
            <label>Teléfono</label>
            <p>
              <ion-icon name="call-outline" class="field-icon"></ion-icon>
              {{ doctorProfile.phone || 'No especificado' }}
            </p>
          </div>

          <div class="view-field">
            <label>Email Institucional</label>
            <p>
              <ion-icon name="mail-outline" class="field-icon"></ion-icon>
              {{ doctorProfile.emailInstitutional || userEmail || 'No especificado' }}
            </p>
          </div>
        </div>

        <!-- Acciones -->
        <div class="form-actions">
          <div class="button-group">
            <ion-button expand="block" class="primary-button" routerLink="/doctor/patients">
              <ion-icon slot="start" name="list-outline"></ion-icon>
              Ver Mis Pacientes
            </ion-button>
            <ion-button expand="block" fill="outline" class="secondary-button" routerLink="/dashboard">
              <ion-icon slot="start" name="home-outline"></ion-icon>
              Ir al Dashboard
            </ion-button>
          </div>
        </div>

        <!-- Navigation Section -->
        <div class="navigation-section">
          <a [routerLink]="['/dashboard']" class="back-link">← Volver al Dashboard</a>
          <app-logout-button [buttonStyle]="'card'" [showConfirmation]="true"></app-logout-button>
        </div>
      </div>
    </div>

    <!-- ========== PERFIL DE PACIENTE (Formulario Original) ========== -->
    <div *ngIf="isPatient || (!isDoctor && !isAdmin)" class="patient-profile-section">
    <!-- Profile Action Section - Envuelve todo el contenido -->
    <div class="action-section">
      <div class="auth-header">
        <div class="logo-placeholder"></div>
        <div class="header-content">
          <div class="header-text">
            <h1>{{ getPageTitle() }}</h1>
            <p>{{ getPageSubtitle() }}</p>
          </div>
          <!-- Botón de Edición -->
          <ion-button 
            *ngIf="isViewMode" 
            fill="clear" 
            class="edit-button"
            (click)="enableEditMode()"
            data-test="edit-profile-button">
            <ion-icon slot="icon-only" name="create-outline"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Progress Indicator - Solo en modo edición -->
      <div class="progress-container" *ngIf="showProgress && !isViewMode">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="completionPercentage$ | async"></div>
        </div>
        <p class="progress-text">Completado: {{ completionPercentage$ | async }}%</p>
      </div>

      <!-- Auto-save indicator - Solo en modo edición -->
      <div class="auto-save-indicator" [class.saving]="isAutoSaving" [class.saved]="lastSaved" *ngIf="!isViewMode">
        <ion-icon [name]="getAutoSaveIcon()"></ion-icon>
        <span>{{ getAutoSaveText() }}</span>
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="auth-form profile-form" data-test="profile-form">
        
        <!-- Navigation Tabs -->
        <div class="form-tabs">
          <ion-segment [(ngModel)]="activeTab" [ngModelOptions]="{standalone: true}" (ionChange)="onTabChange($event)">
            <ion-segment-button value="personal">
              <ion-icon name="person-outline"></ion-icon>
              <ion-label>Personal</ion-label>
              <div class="tab-indicator" [class.complete]="isTabComplete('personal')"></div>
            </ion-segment-button>
            <ion-segment-button value="medical">
              <ion-icon name="medical-outline"></ion-icon>
              <ion-label>Médico</ion-label>
              <div class="tab-indicator" [class.complete]="isTabComplete('medical')"></div>
            </ion-segment-button>
            <ion-segment-button value="lifestyle">
              <ion-icon name="fitness-outline"></ion-icon>
              <ion-label>Estilo de Vida</ion-label>
              <div class="tab-indicator" [class.complete]="isTabComplete('lifestyle')"></div>
            </ion-segment-button>
            <ion-segment-button value="preferences">
              <ion-icon name="settings-outline"></ion-icon>
              <ion-label>Preferencias</ion-label>
              <div class="tab-indicator" [class.complete]="isTabComplete('preferences')"></div>
            </ion-segment-button>
          </ion-segment>
        </div>

        <!-- Personal Information Tab -->
        <div class="tab-content" *ngIf="activeTab === 'personal'">
          <div class="form-section">
            <div class="form-section-header">
              <h3><ion-icon name="person-outline"></ion-icon> Información Personal</h3>
              <p>Datos básicos para tu perfil médico</p>
            </div>

            <!-- Nombre Field -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else firstNameEdit">
                <div class="view-field">
                  <label>Nombre</label>
                  <p>{{ getDisplayValue('first_name') }}</p>
                </div>
              </ng-container>
              <ng-template #firstNameEdit>
                <ion-item lines="none">
                  <ion-input
                    formControlName="first_name"
                    placeholder="Nombre *"
                    data-test="profile-first-name"
                  ></ion-input>
                </ion-item>
              </ng-template>
            </div>

            <!-- Apellido Field -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else lastNameEdit">
                <div class="view-field">
                  <label>Apellido</label>
                  <p>{{ getDisplayValue('last_name') }}</p>
                </div>
              </ng-container>
              <ng-template #lastNameEdit>
                <ion-item lines="none">
                  <ion-input
                    formControlName="last_name"
                    placeholder="Apellido *"
                    data-test="profile-last-name"
                  ></ion-input>
                </ion-item>
              </ng-template>
            </div>

            <!-- Fecha de Nacimiento -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else birthDateEdit">
                <div class="view-field">
                  <label>Fecha de Nacimiento</label>
                  <p>{{ getDisplayValue('birth_date') }}</p>
                </div>
                <div class="age-display" *ngIf="calculatedAge">
                  <span>Edad: {{ calculatedAge }} años</span>
                </div>
              </ng-container>
              <ng-template #birthDateEdit>
                <ion-item lines="none">
                  <ion-input
                    type="date"
                    formControlName="birth_date"
                    placeholder="Fecha de Nacimiento *"
                    [max]="maxDate"
                    data-test="profile-birth-date"
                  ></ion-input>
                </ion-item>
                <div class="age-display" *ngIf="calculatedAge">
                  <span>Edad: {{ calculatedAge }} años</span>
                </div>
              </ng-template>
            </div>

            <!-- Género -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else genderEdit">
                <div class="view-field">
                  <label>Género</label>
                  <p>{{ getDisplayValue('gender') }}</p>
                </div>
              </ng-container>
              <ng-template #genderEdit>
                <ion-item lines="none">
                  <ion-select
                    formControlName="gender"
                    placeholder="Género *"
                    interface="action-sheet"
                    data-test="profile-gender"
                  >
                    <ion-select-option value="MALE">Masculino</ion-select-option>
                    <ion-select-option value="FEMALE">Femenino</ion-select-option>
                    <ion-select-option value="OTHER">Otro</ion-select-option>
                    <ion-select-option value="PREFER_NOT_TO_SAY">Prefiero no decirlo</ion-select-option>
                  </ion-select>
                </ion-item>
              </ng-template>
            </div>

            <!-- Teléfono con formato automático -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else phoneEdit">
                <div class="view-field">
                  <label>Teléfono</label>
                  <p>{{ getDisplayValue('phone') }}</p>
                </div>
              </ng-container>
              <ng-template #phoneEdit>
                <ion-item lines="none">
                  <ion-input
                    formControlName="phone"
                    placeholder="Teléfono"
                    type="tel"
                    data-test="profile-phone"
                    (ionInput)="formatPhone($event)"
                  ></ion-input>
                </ion-item>
              </ng-template>
            </div>

            <!-- Ocupación -->
            <div class="form-group">
              <ng-container *ngIf="isViewMode; else occupationEdit">
                <div class="view-field">
                  <label>Ocupación</label>
                  <p>{{ getDisplayValue('occupation') }}</p>
                </div>
              </ng-container>
              <ng-template #occupationEdit>
                <ion-item lines="none">
                  <ion-input
                    formControlName="occupation"
                    placeholder="Ocupación"
                    data-test="profile-occupation"
                  ></ion-input>
                </ion-item>
              </ng-template>
            </div>

            <!-- Contacto de Emergencia -->
            <div class="subsection">
              <h4><ion-icon name="call-outline"></ion-icon> Contacto de Emergencia</h4>
              
              <div class="form-group">
                <ng-container *ngIf="isViewMode; else emergencyNameEdit">
                  <div class="view-field">
                    <label>Nombre del contacto</label>
                    <p>{{ getDisplayValue('emergency_contact_name') }}</p>
                  </div>
                </ng-container>
                <ng-template #emergencyNameEdit>
                  <ion-item lines="none">
                    <ion-input
                      formControlName="emergency_contact_name"
                      placeholder="Nombre del contacto de emergencia"
                      data-test="emergency-contact-name"
                    ></ion-input>
                  </ion-item>
                </ng-template>
              </div>

              <div class="form-group">
                <ng-container *ngIf="isViewMode; else emergencyPhoneEdit">
                  <div class="view-field">
                    <label>Teléfono del contacto</label>
                    <p>{{ getDisplayValue('emergency_contact_phone') }}</p>
                  </div>
                </ng-container>
                <ng-template #emergencyPhoneEdit>
                  <ion-item lines="none">
                    <ion-input
                      formControlName="emergency_contact_phone"
                      placeholder="Teléfono del contacto de emergencia"
                      type="tel"
                      data-test="emergency-contact-phone"
                      (ionInput)="formatPhone($event)"
                    ></ion-input>
                  </ion-item>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <!-- Medical Information Tab -->
        <div class="tab-content" *ngIf="activeTab === 'medical'">
          <div class="form-section">
            <div class="form-section-header">
              <h3><ion-icon name="medical-outline"></ion-icon> Información Médica</h3>
              <p>Historial médico y condiciones actuales</p>
            </div>

            <!-- Historial Médico -->
            <div class="subsection">
              <h4><ion-icon name="document-text-outline"></ion-icon> Historial Médico</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-list" *ngIf="hasArrayData('medical_history')">
                  <div class="view-list-item" *ngFor="let condition of medicalHistoryArray.controls; let i = index">
                    <ng-container *ngIf="condition.get('condition')?.value">
                      <ion-icon name="medical-outline" color="primary"></ion-icon>
                      <span>{{ condition.get('condition')?.value }}</span>
                    </ng-container>
                  </div>
                </div>
                <p class="empty-message" *ngIf="!hasArrayData('medical_history')">
                  No hay condiciones médicas registradas
                </p>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div formArrayName="medical_history">
                  <div *ngFor="let condition of medicalHistoryArray.controls; let i = index" 
                       class="dynamic-item" 
                       [formGroupName]="i">
                    <ion-item lines="none">
                      <ion-input
                        formControlName="condition"
                        placeholder="Condición médica"
                      ></ion-input>
                      <ion-button 
                        slot="end" 
                        fill="clear" 
                        color="danger" 
                        (click)="removeMedicalHistory(i)"
                        [disabled]="medicalHistoryArray.length === 1"
                      >
                        <ion-icon name="close-circle-outline"></ion-icon>
                      </ion-button>
                    </ion-item>
                  </div>
                </div>

                <ion-button 
                  expand="block" 
                  fill="outline" 
                  class="add-button" 
                  (click)="addMedicalHistory()"
                >
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Agregar Condición Médica
                </ion-button>
              </ng-container>
            </div>

            <!-- Alergias -->
            <div class="subsection">
              <h4><ion-icon name="warning-outline"></ion-icon> Alergias</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-list" *ngIf="hasArrayData('allergies')">
                  <div class="view-list-item" *ngFor="let allergy of allergiesArray.controls; let i = index">
                    <ng-container *ngIf="allergy.get('allergen')?.value">
                      <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
                      <span>{{ allergy.get('allergen')?.value }}</span>
                    </ng-container>
                  </div>
                </div>
                <p class="empty-message" *ngIf="!hasArrayData('allergies')">
                  No hay alergias registradas
                </p>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div formArrayName="allergies">
                  <div *ngFor="let allergy of allergiesArray.controls; let i = index" 
                       class="dynamic-item" 
                       [formGroupName]="i">
                    <ion-item lines="none">
                      <ion-input
                        formControlName="allergen"
                        placeholder="Alérgeno"
                      ></ion-input>
                      <ion-button 
                        slot="end" 
                        fill="clear" 
                        color="danger" 
                        (click)="removeAllergy(i)"
                        [disabled]="allergiesArray.length === 1"
                      >
                        <ion-icon name="close-circle-outline"></ion-icon>
                      </ion-button>
                    </ion-item>
                  </div>
                </div>

                <ion-button 
                  expand="block" 
                  fill="outline" 
                  class="add-button" 
                  (click)="addAllergy()"
                >
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Agregar Alergia
                </ion-button>
              </ng-container>
            </div>

            <!-- Medicamentos Actuales -->
            <div class="subsection">
              <h4><ion-icon name="medical-outline"></ion-icon> Medicamentos Actuales</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-list" *ngIf="hasArrayData('current_medications')">
                  <div class="view-list-item" *ngFor="let medication of currentMedicationsArray.controls; let i = index">
                    <ng-container *ngIf="medication.get('name')?.value">
                      <ion-icon name="bandage-outline" color="tertiary"></ion-icon>
                      <span>{{ medication.get('name')?.value }}</span>
                    </ng-container>
                  </div>
                </div>
                <p class="empty-message" *ngIf="!hasArrayData('current_medications')">
                  No hay medicamentos registrados
                </p>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div formArrayName="current_medications">
                  <div *ngFor="let medication of currentMedicationsArray.controls; let i = index" 
                       class="dynamic-item" 
                       [formGroupName]="i">
                    <ion-item lines="none">
                      <ion-input
                        formControlName="name"
                        placeholder="Nombre del medicamento"
                      ></ion-input>
                      <ion-button 
                        slot="end" 
                        fill="clear" 
                        color="danger" 
                        (click)="removeMedication(i)"
                        [disabled]="currentMedicationsArray.length === 1"
                      >
                        <ion-icon name="close-circle-outline"></ion-icon>
                      </ion-button>
                    </ion-item>
                  </div>
                </div>

                <ion-button 
                  expand="block" 
                  fill="outline" 
                  class="add-button" 
                  (click)="addMedication()"
                >
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Agregar Medicamento
                </ion-button>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- Lifestyle Tab -->
        <div class="tab-content" *ngIf="activeTab === 'lifestyle'">
          <div class="form-section" formGroupName="lifestyle_factors">
            <div class="form-section-header">
              <h3><ion-icon name="fitness-outline"></ion-icon> Estilo de Vida</h3>
              <p>Factores que influyen en tu salud pulmonar</p>
            </div>

            <!-- Historial de Tabaquismo -->
            <div class="subsection">
              <h4><ion-icon name="leaf-outline"></ion-icon> Historial de Tabaquismo</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-field">
                  <label>Estado de Fumador</label>
                  <p>{{ getLifestyleLabel('smoking_status', profileForm.get('lifestyle_factors.smoking_status')?.value) }}</p>
                </div>
                <div class="view-field" *ngIf="showPackYears">
                  <label>Paquetes-año</label>
                  <p>{{ profileForm.get('lifestyle_factors.smoking_pack_years')?.value || '0' }}</p>
                </div>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <!-- Smoking Status -->
                <div class="form-group">
                  <ion-item lines="none">
                    <ion-select
                      formControlName="smoking_status"
                      placeholder="Estado de Fumador *"
                      interface="action-sheet"
                    >
                      <ion-select-option value="NEVER">Nunca he fumado</ion-select-option>
                      <ion-select-option value="FORMER">Ex fumador</ion-select-option>
                      <ion-select-option value="CURRENT">Fumador actual</ion-select-option>
                      <ion-select-option value="OCCASIONAL">Fumador ocasional</ion-select-option>
                    </ion-select>
                  </ion-item>
                </div>

                <!-- Pack Years (solo para fumadores/ex-fumadores) -->
                <div class="form-group" *ngIf="showPackYears">
                  <label class="form-label">Paquetes-año</label>
                  <ion-item lines="none">
                    <ion-input
                      formControlName="smoking_pack_years"
                      placeholder="Número de paquetes-año"
                      type="number"
                      min="0"
                      step="0.1"
                    ></ion-input>
                  </ion-item>
                </div>
              </ng-container>
            </div>

            <!-- Consumo de Alcohol -->
            <div class="subsection">
              <h4><ion-icon name="water-outline"></ion-icon> Consumo de Alcohol</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-field">
                  <label>Consumo de Alcohol</label>
                  <p>{{ getLifestyleLabel('alcohol_consumption', profileForm.get('lifestyle_factors.alcohol_consumption')?.value) }}</p>
                </div>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div class="form-group">
                  <ion-item lines="none">
                    <ion-select
                      formControlName="alcohol_consumption"
                      placeholder="Consumo de Alcohol"
                      interface="action-sheet"
                    >
                      <ion-select-option value="NONE">No consume</ion-select-option>
                      <ion-select-option value="OCCASIONAL">Ocasional</ion-select-option>
                      <ion-select-option value="MODERATE">Moderado</ion-select-option>
                      <ion-select-option value="FREQUENT">Frecuente</ion-select-option>
                      <ion-select-option value="DAILY">Diario</ion-select-option>
                    </ion-select>
                  </ion-item>
                </div>
              </ng-container>
            </div>

            <!-- Actividad Física -->
            <div class="subsection">
              <h4><ion-icon name="fitness-outline"></ion-icon> Actividad Física</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-field">
                  <label>Frecuencia de Ejercicio</label>
                  <p>{{ getLifestyleLabel('exercise_frequency', profileForm.get('lifestyle_factors.exercise_frequency')?.value) }}</p>
                </div>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div class="form-group">
                  <ion-item lines="none">
                    <ion-select
                      formControlName="exercise_frequency"
                      placeholder="Frecuencia de Ejercicio *"
                      interface="action-sheet"
                    >
                      <ion-select-option value="NEVER">Nunca</ion-select-option>
                      <ion-select-option value="RARELY">Raramente</ion-select-option>
                      <ion-select-option value="WEEKLY">Semanal</ion-select-option>
                      <ion-select-option value="FREQUENT">Frecuente</ion-select-option>
                      <ion-select-option value="DAILY">Diario</ion-select-option>
                    </ion-select>
                  </ion-item>
                </div>
              </ng-container>
            </div>

            <!-- Descanso y Sueño -->
            <div class="subsection">
              <h4><ion-icon name="moon-outline"></ion-icon> Descanso y Sueño</h4>
              
              <!-- Modo Visualización -->
              <ng-container *ngIf="isViewMode">
                <div class="view-field">
                  <label>Horas de Sueño por Noche</label>
                  <p>{{ profileForm.get('lifestyle_factors.sleep_hours')?.value || '8' }} horas</p>
                </div>
              </ng-container>

              <!-- Modo Edición -->
              <ng-container *ngIf="!isViewMode">
                <div class="form-group">
                  <label class="form-label">Horas de Sueño por Noche *</label>
                  <ion-item lines="none">
                    <ion-input
                      formControlName="sleep_hours"
                      placeholder="Horas promedio de sueño"
                      type="number"
                      min="4"
                      max="12"
                      step="0.5"
                    ></ion-input>
                  </ion-item>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div class="tab-content" *ngIf="activeTab === 'preferences'">
          <div class="form-section">
            <div class="form-section-header">
              <h3><ion-icon name="settings-outline"></ion-icon> Preferencias</h3>
              <p>Configuración de idioma, comunicación y privacidad</p>
            </div>

            <!-- Language Preference -->
            <div class="form-group">
              <ion-item lines="none">
                <ion-select
                  formControlName="preferred_language"
                  placeholder="Idioma Preferido *"
                  interface="action-sheet"
                >
                  <ion-select-option value="es">Español</ion-select-option>
                  <ion-select-option value="en">English</ion-select-option>
                  <ion-select-option value="pt">Português</ion-select-option>
                  <ion-select-option value="fr">Français</ion-select-option>
                </ion-select>
              </ion-item>
            </div>

            <!-- Communication Method -->
            <div class="form-group">
              <ion-item lines="none">
                <ion-select
                  formControlName="preferred_communication_method"
                  placeholder="Método de Comunicación Preferido *"
                  interface="action-sheet"
                >
                  <ion-select-option value="EMAIL">Correo Electrónico</ion-select-option>
                  <ion-select-option value="PHONE">Teléfono</ion-select-option>
                  <ion-select-option value="SMS">SMS</ion-select-option>
                  <ion-select-option value="IN_APP">Notificaciones en App</ion-select-option>
                </ion-select>
              </ion-item>
            </div>

            <!-- Consent Checkboxes -->
            <div class="consent-section">
              <h4>Consentimientos y Privacidad</h4>
              
              <div class="checkbox-group">
                <ion-item lines="none" button (click)="toggleConsent('consent_terms')">
                  <ion-checkbox 
                    formControlName="consent_terms" 
                    slot="start"
                  ></ion-checkbox>
                  <ion-label>
                    <h3>Acepto los términos y condiciones *</h3>
                    <p>Necesario para usar la aplicación</p>
                  </ion-label>
                </ion-item>
                <div class="error-message" *ngIf="getFieldError('consent_terms')">
                  Debes aceptar los términos y condiciones
                </div>

                <ion-item lines="none" button (click)="toggleConsent('consent_data_sharing')">
                  <ion-checkbox 
                    formControlName="consent_data_sharing" 
                    slot="start"
                  ></ion-checkbox>
                  <ion-label>
                    <h3>Compartir datos para investigación</h3>
                    <p>Ayuda a mejorar los tratamientos (opcional)</p>
                  </ion-label>
                </ion-item>

                <ion-item lines="none" button (click)="toggleConsent('consent_marketing')">
                  <ion-checkbox 
                    formControlName="consent_marketing" 
                    slot="start"
                  ></ion-checkbox>
                  <ion-label>
                    <h3>Recibir información de salud</h3>
                    <p>Tips de salud y noticias médicas (opcional)</p>
                  </ion-label>
                </ion-item>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <div class="button-group">
            <!-- Botones en modo visualización -->
            <ng-container *ngIf="isViewMode">
              <ion-button 
                expand="block" 
                type="button"
                fill="outline"
                (click)="enableEditMode()"
                class="secondary-button"
              >
                <ion-icon name="create-outline" slot="start"></ion-icon>
                Editar Perfil
              </ion-button>
            </ng-container>

            <!-- Botones en modo edición -->
            <ng-container *ngIf="!isViewMode">
              <ion-button 
                expand="block" 
                type="button"
                fill="outline"
                (click)="cancelEdit()"
                [disabled]="isSubmitting"
                class="secondary-button"
              >
                <ion-icon name="close-outline" slot="start"></ion-icon>
                Cancelar
              </ion-button>

              <ion-button 
                expand="block" 
                type="submit"
                [disabled]="isSubmitting"
                class="primary-button"
              >
                <ion-icon [name]="isSubmitting ? 'hourglass-outline' : 'checkmark-circle'" slot="start"></ion-icon>
                {{ isSubmitting ? 'Guardando...' : 'Guardar Cambios' }}
              </ion-button>
            </ng-container>
          </div>

          <!-- Form Validation Summary -->
          <div class="validation-summary" *ngIf="showValidationSummary">
            <h4>Campos pendientes por completar:</h4>
            <ul>
              <li *ngFor="let error of validationErrors">{{ error }}</li>
            </ul>
          </div>
        </div>

      </form>

      <!-- Error Display -->
      <div class="error" *ngIf="error">
        {{ error }}
      </div>

      <!-- Navigation Section -->
      <div class="navigation-section">
        <a [routerLink]="['/dashboard']" class="back-link">← Volver al Dashboard</a>
        <app-logout-button [buttonStyle]="'card'" [showConfirmation]="true"></app-logout-button>
      </div>
    </div>
    </div>
    <!-- End patient-profile-section -->

  </div>
  <!-- End welcome-container -->
</ion-content>
